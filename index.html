<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WYFC61KVQZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-WYFC61KVQZ');
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kerala Dam Water Levels</title>

    <meta name="description" content="Monitor real-time water levels of dams in Kerala. View interactive maps, charts, and historical data for Kerala's major dams. Stay informed about dam water storage, inflow, outflow, and rainfall.">
    <meta name="keywords" content="Kerala dams, water levels, dam storage, rainfall, inflow, outflow, interactive map, real-time data">
    <meta name="author" content="Amith V">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://damstats.amithv.xyz/">
    <meta property="og:title" content="Kerala Dam Water Levels | Real-time Monitoring">
    <meta property="og:description" content="Monitor real-time water levels of dams in Kerala. View interactive maps, charts, and historical data for Kerala's major dams.">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://damstats.amithv.xyz/">
    <meta property="twitter:title" content="Kerala Dam Water Levels | Real-time Monitoring">
    <meta property="twitter:description" content="Monitor real-time water levels of dams in Kerala. View interactive maps, charts, and historical data for Kerala's major dams.">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://damstats.amithv.xyz/">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/dam.png">


    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.3.0"></script>
    <style>
    </style>

    <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "n2sjfifq6d");
</script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Kerala Dam Water Levels </h1>
            <div class="circle"></div>
            <span id="lastUpdate"></span>
        </div>

        <div class="main-content">
            <div class="map-container">
                <div id="map"></div>
            </div>
            <div class="mobile-header">
                <h1>Kerala Dam Water Levels</h1>
                <span id="mobileLastUpdate"></span>
            </div>
            <div id="sidebar">

                <button id="sortButton">Sort by Storage Percentage</button>
                <div id="damList"></div>
                <div id="chartContainer">
                    <canvas id="damChart"></canvas>
                </div>
                <div class="attribution">
                  <a href="https://dams.kseb.in/" target="_blank">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512">
                        <path fill="currentColor" d="M245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93-22.13 0-33.22 14.61-33.22 43.84 0 23.57 9.21 43.84 33.22 43.84 14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98-22.6 0-73.96-10.32-73.96-77.05 0-58.69 43-77.06 72.63-77.06 30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93-22.14 0-33.22 14.61-33.22 43.84 0 23.55 9.23 43.84 33.22 43.84 14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98-22.69 0-73.96-9.87-73.96-77.05 0-58.67 42.97-77.06 72.63-77.06 30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248 129.93 0 248.44-100.87 248.44-248 0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81 0-105.42 85.43-203.27 203.72-203.27 112.53 0 202.82 89.46 202.82 203.26-.01 121.69-99.68 202.82-202.84 202.82z"/>
                    </svg>
                    dams.kseb.in
                </a>
                
                  <a href="https://amithv.xyz" target="_blank">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                          <polyline points="15 3 21 3 21 9"></polyline>
                          <line x1="10" y1="14" x2="21" y2="3"></line>
                      </svg>
                      amithv.xyz
                  </a>
                  
                  <a href="https://github.com/amith-vp/Kerala-Dam-Water-Levels" target="_blank">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                      </svg>
                  </a>
                  <a href="https://buymeacoffee.com/amithv" target="_blank">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m20.216 6.415-.132-.666c-.119-.598-.388-1.163-1.001-1.379-.197-.069-.42-.098-.57-.241-.152-.143-.196-.366-.231-.572-.065-.378-.125-.756-.192-1.133-.057-.325-.102-.69-.25-.987-.195-.4-.597-.634-.996-.788a5.723 5.723 0 0 0-.626-.194c-1-.263-2.05-.36-3.077-.416a25.834 25.834 0 0 0-3.7.062c-.915.083-1.88.184-2.75.5-.318.116-.646.256-.888.501-.297.302-.393.77-.177 1.146.154.267.415.456.692.58.36.162.737.284 1.123.366 1.075.238 2.189.331 3.287.37 1.218.05 2.437.01 3.65-.118.299-.033.598-.073.896-.119.352-.054.578-.513.474-.834-.124-.383-.457-.531-.834-.473-.466.074-.96.108-1.382.146-1.177.08-2.358.082-3.536.006a22.228 22.228 0 0 1-1.157-.107c-.086-.01-.18-.025-.258-.036-.243-.036-.484-.08-.724-.13-.111-.027-.111-.185 0-.212h.005c.277-.06.557-.108.838-.147h.002c.131-.009.263-.032.394-.048a25.076 25.076 0 0 1 3.426-.12c.674.019 1.347.067 2.017.144l.228.031c.267.04.533.088.798.145.392.085.895.113 1.07.542.055.137.08.288.111.431l.319 1.484a.237.237 0 0 1-.199.284h-.003c-.037.006-.075.01-.112.015a36.704 36.704 0 0 1-4.743.295 37.059 37.059 0 0 1-4.699-.304c-.14-.017-.293-.042-.417-.06-.326-.048-.649-.108-.973-.161-.393-.065-.768-.032-1.123.161-.29.16-.527.404-.675.701-.154.316-.199.66-.267 1-.069.34-.176.707-.135 1.056.087.753.613 1.365 1.37 1.502a39.69 39.69 0 0 0 11.343.376.483.483 0 0 1 .535.53l-.071.697-1.018 9.907c-.041.41-.047.832-.125 1.237-.122.637-.553 1.028-1.182 1.171-.577.131-1.165.2-1.756.205-.656.004-1.31-.025-1.966-.022-.699.004-1.556-.06-2.095-.58-.475-.458-.54-1.174-.605-1.793l-.731-7.013-.322-3.094c-.037-.351-.286-.695-.678-.678-.336.015-.718.3-.678.679l.228 2.185.949 9.112c.147 1.344 1.174 2.068 2.446 2.272.742.12 1.503.144 2.257.156.966.016 1.942.053 2.892-.122 1.408-.258 2.465-1.198 2.616-2.657.34-3.332.683-6.663 1.024-9.995l.215-2.087a.484.484 0 0 1 .39-.426c.402-.078.787-.212 1.074-.518.455-.488.546-1.124.385-1.766zm-1.478.772c-.145.137-.363.201-.578.233-2.416.359-4.866.54-7.308.46-1.748-.06-3.477-.254-5.207-.498-.17-.024-.353-.055-.47-.18-.22-.236-.111-.71-.054-.995.052-.26.152-.609.463-.646.484-.057 1.046.148 1.526.22.577.088 1.156.159 1.737.212 2.48.226 5.002.19 7.472-.14.45-.06.899-.13 1.345-.21.399-.072.84-.206 1.08.206.166.281.188.657.162.974a.544.544 0 0 1-.169.364zm-6.159 3.9c-.862.37-1.84.788-3.109.788a5.884 5.884 0 0 1-1.569-.217l.877 9.004c.065.78.717 1.38 1.5 1.38 0 0 1.243.065 1.658.065.447 0 1.786-.065 1.786-.065.783 0 1.434-.6 1.499-1.38l.94-9.95a3.996 3.996 0 0 0-1.322-.238c-.826 0-1.491.284-2.26.613z"/>
                    </svg>
                </a>
                
              </div>
            </div>
        </div>
        <div id="damDetails">
            <button id="closeButton">
                <svg width="20" height="20" viewbox="0 0 40 40">
                    <path d="M 10,10 L 30,30 M 30,10 L 10,30" stroke="black" stroke-width="4" />
                </svg>
            </button>
            <div id="damDetailsContent"></div>
            <div id="timeRangeSelectContainer">
                <select id="timeRangeSelect">
                    <option value="7">1 Week</option>
                    <option value="30" selected>1 Month</option>
                    <option value="60">2 Months</option>
                    <option value="90">3 Months</option>
                    <option value="180">6 Months</option>
                    <option value="365">1 Year</option>
                    <option value="730">2 Years</option>
                </select>
            </div>
            <div class="chart-container">
                <canvas id="waterLevelChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="storageChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="inflowChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="rainfallChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="dischargeChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
          const keralaBounds = L.latLngBounds([8.2878, 74.8559], [12.8183, 80.4122]);
          const map = L.map("map", {
            center: [9.8756, 77.0394],
            zoom: 11,
            minZoom: 7,
            maxBounds: keralaBounds,
            maxBoundsViscosity: 1.0,
          });
        
          L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          }).addTo(map);
        
          const elements = {
            damList: document.getElementById("damList"),
            lastUpdate: document.getElementById("lastUpdate"),
            mobileLastUpdate: document.getElementById("mobileLastUpdate"),
            sortButton: document.getElementById("sortButton"),
            damDetails: document.getElementById("damDetails"),
            damDetailsContent: document.getElementById("damDetailsContent"),
            closeButton: document.getElementById("closeButton"),
            timeRangeSelect: document.getElementById("timeRangeSelect"),
          };
        
          let dams = [];
          let chart;
          const markers = L.layerGroup().addTo(map);
          let selectedTimeRange = 30;
        
          const sortOptions = [
            { key: "storagePercentage", label: "Storage Percentage", chartType: "bar" },
            { key: "liveStorage", label: "Current Storage", chartType: "bar" },
            { key: "totalCapacity", label: "Total Capacity", chartType: "bar" },
            { key: "inflow", label: "Inflow", chartType: "line" },
            { key: "powerhouseDischarge", label: "Powerhouse Discharge", chartType: "line" },
            { key: "spillwayRelease", label: "Spillway Release", chartType: "line" },
            { key: "totalOutflow", label: "Total Outflow", chartType: "line" },
            { key: "rainfall", label: "Rainfall", chartType: "bar" },
            { key: "name", label: "Name", chartType: "bar" },
          ];
          let currentSortOption = sortOptions[0];
        
        
          // marker
          const createWaterLevelIcon = (percentage) => {
            return L.divIcon({
              className: "water-level-icon",
              html: `
                <div class="water-level-indicator">
                  <div class="water-level" style="height: ${percentage}%; background-color: ${getWaterLevelColor(percentage)};"></div>
                </div>
              `,
            });
          };
        
          const updateMarkers = () => {
            markers.clearLayers();
            dams.forEach((dam) => {
              const percentage = parseFloat(dam.data[0].storagePercentage);
              const marker = L.marker([dam.latitude, dam.longitude], {
                icon: createWaterLevelIcon(percentage),
              }).on("click", () => showDamDetails(dam));
        
              L.marker([dam.latitude, dam.longitude], {
                icon: L.divIcon({
                  className: "",
                  html: `<div class="dam-label">${dam.name}</div>`,
                }),
              }).addTo(markers);
        
              markers.addLayer(marker);
            });
          };
        
          //only show marker labels when zoomed in
          map.on("zoomend", () => {
            const currentZoom = map.getZoom();
            document.querySelectorAll(".dam-label").forEach((label) => {
              label.style.display = currentZoom >= 10 ? "block" : "none";
            });
          });
        
          const getWaterLevelColor = (percentage) => {
            const level = parseFloat(percentage);
            if (level < 20) return "#90EE90";
            if (level < 40) return "#ADFF2F";
            if (level < 60) return "#FFFF00";
            if (level < 80) return "#FFA500";
            return "#FF0000";
          };
        
          const formatUnits = {
            waterLevel: "m",
            liveStorage: "MCM",
            totalCapacity: "MCM",
            inflow: "cumecs",
            powerhouseDischarge: "cumecs",
            spillwayRelease: "cumecs",
            totalOutflow: "cumecs",
            rainfall: "mm",
            storagePercentage: "%",
          };
        
          const formatValue = (value, property) => {
            return typeof value === "number" && !isNaN(value)
              ? `${value.toFixed(2)}${formatUnits[property] || ""}`
              : property === "name"
              ? value
              : "N/A";
          };
        
          const fetchDamHistoricalData = async (damName) => {
            try {
              const response = await fetch(
                `https://raw.githubusercontent.com/amith-vp/Kerala-Dam-Water-Levels/main/historic_data/${encodeURIComponent(
                  damName.replace(/\s+/g, "_")
                )}.json`
              );
              return await response.json();
            } catch (error) {
              console.error("Error fetching historical dam data:", error);
              return null;
            }
          };
        
          // KSEB data contains inconsistent date formats, so the data for the last n days is fetched by calculating the number of days and then slicing the array for the last n days.
        
          const getDataForTimeRange = (data, days) => data.slice(-days);
        
          // Detailed dam information when clicked on a dam marker/name
          const showDamDetails = async (dam) => {
            const historicalData = await fetchDamHistoricalData(dam.name);
            if (historicalData) {
              elements.damDetailsContent.innerHTML = createDetailedContent(historicalData);
              historicalData.data.reverse();
              createWaterLevelChart(historicalData);
              createStorageChart(historicalData);
              createInflowChart(historicalData);
              createRainfallChart(historicalData);
              createDischargeChart(historicalData);
              elements.damDetails.style.display = "block";
            } else {
              alert("Failed to fetch historical data for this dam.");
            }
          };
        
          // sort option by time range
          elements.timeRangeSelect.addEventListener("change", (event) => {
            selectedTimeRange = parseInt(event.target.value);
            if (elements.damDetails.style.display === "block") {
              const activeDamName = elements.damDetailsContent.querySelector("h2").textContent.split(" (")[0];
              const activeDam = dams.find((dam) => dam.name === activeDamName);
              if (activeDam) {
                showDamDetails(activeDam);
              }
            }
          });
        
          // basic dam information from historic api
          const createDetailedContent = (damData) => {
            const latestData = damData.data[0];
            return `
              <div class="dam-details-container">
                <h2 class="dam-name">${damData.name}</h2>
                <div class="dam-info-grid">
                  <div class="dam-info-column">
                    <h4 class="info-section-title">Current Status</h4>
                    ${createInfoItem("Water Level", `${latestData.waterLevel} m`)}
                    ${createInfoItem("Storage", `${latestData.liveStorage} MCM (${latestData.storagePercentage})`)}
                    ${createInfoItem("Inflow", `${latestData.inflow} cumecs`)}
                    ${createInfoItem("Outflow", `${latestData.totalOutflow} cumecs`)}
                    ${createInfoItem("Rainfall", `${latestData.rainfall} mm`)}
                  </div>
                  <div class="dam-info-column">
                    <h4 class="info-section-title">Dam Specifications</h4>
                    ${createInfoItem("Maximum Water Level", `${damData.MWL} m`)}
                    ${createInfoItem("Full Reservoir Level", `${damData.FRL} m`)}
                    ${createInfoItem("Total Capacity", `${damData.liveStorageAtFRL} MCM`)}
                    ${createInfoItem("Red Alert Level", `${damData.redLevel} m`)}
                    ${createInfoItem("Orange Alert Level", `${damData.orangeLevel} m`)}
                  </div>
                </div>
              </div>
            `;
          };
        
          const createInfoItem = (label, value) => `
            <div class="dam-info-item">
              <strong class="info-label">${label}:</strong>
              <span class="info-value">${value}</span>
            </div>
          `;
        
          //chart js options
          const createChartOptions = (title, yAxisLabel, startAtZero, annotations = []) => ({
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: { display: true, text: title, color: "#e2e8f0" },
              tooltip: { mode: "index", intersect: false },
              annotation: {
                annotations: annotations.map((ann) => ({
                  type: "line",
                  yMin: ann.value,
                  yMax: ann.value,
                  borderColor: ann.borderColor,
                  borderWidth: 2,
                  label: {
                    content: ann.label,
                    enabled: true,
                    yAdjust: 10,
                    position: "start",
                    backgroundColor: "transparent",
                    color: ann.borderColor,
                  },
                })),
              },
            },
            scales: {
              y: {
                beginAtZero: startAtZero,
                ticks: { color: "#e2e8f0" },
                grid: { color: "rgba(255, 255, 255, 0.1)" },
                title: { display: true, text: yAxisLabel, color: "#e2e8f0" },
              },
              x: {
                reverse: true,
                ticks: { color: "#e2e8f0", maxRotation: 45, minRotation: 45 },
                grid: { color: "rgba(255, 255, 255, 0.1)" },
              },
            },
          });
        
          const createChart = (ctx, type, data, options) => new Chart(ctx, { type, data, options });
        
          let waterLevelChart, storageChart, inflowChart, rainfallChart, dischargeChart;
        
          const createWaterLevelChart = (damData) => {
            const ctx = document.getElementById("waterLevelChart").getContext("2d");
            if (waterLevelChart) {
              waterLevelChart.destroy();
            }
        
        
            const filteredData = getDataForTimeRange(damData.data, selectedTimeRange);
        
            //max data is calculated to set maximum value of y axis (to fix FRL value not rendering in chart)
            const maxDataValue = Math.max(...filteredData.map((d) => parseFloat(d.waterLevel)));
            const frlValue = parseFloat(damData.FRL);
            const maxChartValue = Math.max(maxDataValue, frlValue);
            const yAxisMax = maxChartValue + 1;
        
            waterLevelChart = new Chart(ctx, {
              type: "line",
              data: {
                labels: filteredData.map((d) => d.date).reverse(),
                datasets: [
                  {
                    label: "Water Level (m)",
                    data: filteredData.map((d) => parseFloat(d.waterLevel)).reverse(),
                    borderColor: "rgb(75, 192, 192)",
                    tension: 0.1,
                  },
                ],
              },
              options: {
                ...createChartOptions(
                  "Water Level Over Time",
                  "Water Level (m)",
                  false,
                  [
                    { value: frlValue, label: "FRL", borderColor: "#1ABC9C" },
                    damData.orangeLevel
                      ? { value: parseFloat(damData.orangeLevel), label: "Orange Alert", borderColor: "#ff4d00" }
                      : null,
                    damData.redLevel
                      ? { value: parseFloat(damData.redLevel), label: "Red Alert", borderColor: "#ff0000" }
                      : null,
                  ].filter((annotation) => annotation !== null)
                ),
                scales: {
                  y: {
                    suggestedMax: yAxisMax,
                    display: true,
                    title: { display: true, text: "Water Level (m)" },
                  },
                  x: { reverse: true },
                },
              },
            });
          };
        
          const createStorageChart = (damData) => {
            const ctx = document.getElementById("storageChart").getContext("2d");
            if (storageChart) {
              storageChart.destroy();
            }
            const filteredData = getDataForTimeRange(damData.data, selectedTimeRange);
        
            storageChart = createChart(
              ctx,
              "line",
              {
                labels: filteredData.map((d) => d.date).reverse(),
                datasets: [
                  {
                    label: "Storage Percentage (%)",
                    data: filteredData.map((d) => parseFloat(d.storagePercentage)).reverse(),
                    borderColor: "rgb(255, 159, 64)",
                    tension: 0.1,
                  },
                ],
              },
              createChartOptions("Storage Over Time", "Storage Percentage (%)", true, [])
            );
          };
        
          const createInflowChart = (damData) => {
            const ctx = document.getElementById("inflowChart").getContext("2d");
            if (inflowChart) {
              inflowChart.destroy();
            }
            const filteredData = getDataForTimeRange(damData.data, selectedTimeRange);
        
            inflowChart = createChart(
              ctx,
              "line",
              {
                labels: filteredData.map((d) => d.date).reverse(),
                datasets: [
                  {
                    label: "Inflow (cumecs)",
                    data: filteredData.map((d) => parseFloat(d.inflow)).reverse(),
                    borderColor: "rgb(75, 192, 192)",
                    tension: 0.1,
                  },
                ],
              },
              createChartOptions("Inflow Over Time", "Flow (cumecs)", true)
            );
          };
        
          const createRainfallChart = (damData) => {
            const ctx = document.getElementById("rainfallChart").getContext("2d");
            if (rainfallChart) {
              rainfallChart.destroy();
            }
            const filteredData = getDataForTimeRange(damData.data, selectedTimeRange);
        
            rainfallChart = createChart(
              ctx,
              "bar",
              {
                labels: filteredData.map((d) => d.date).reverse(),
                datasets: [
                  {
                    label: "Rainfall (mm)",
                    data: filteredData.map((d) => parseFloat(d.rainfall)).reverse(),
                    backgroundColor: "rgba(54, 162, 235, 0.5)",
                    borderColor: "rgb(54, 162, 235)",
                    borderWidth: 1,
                  },
                ],
              },
              createChartOptions("Rainfall Over Time", "Rainfall (mm)", true)
            );
          };
        
          const createDischargeChart = (damData) => {
            const ctx = document.getElementById("dischargeChart").getContext("2d");
            if (dischargeChart) {
              dischargeChart.destroy();
            }
            const filteredData = getDataForTimeRange(damData.data, selectedTimeRange);
        
            dischargeChart = createChart(
              ctx,
            "line",
            {
              labels: filteredData.map((d) => d.date).reverse(),
              datasets: [
                {
                  label: "Powerhouse Discharge (cumecs)",
                  data: filteredData.map((d) => parseFloat(d.powerHouseDischarge)).reverse(),
                  borderColor: "rgb(255, 206, 86)",
                  tension: 0.1,
                },
                {
                  label: "Spillway Release (cumecs)",
                  data: filteredData.map((d) => parseFloat(d.spillwayRelease)).reverse(),
                  borderColor: "rgb(75, 192, 192)",
                  tension: 0.1,
                },
                {
                  label: "Total Outflow (cumecs)",
                  data: filteredData.map((d) => parseFloat(d.totalOutflow)).reverse(),
                  borderColor: "rgb(255, 99, 132)",
                  tension: 0.1,
                },
              ],
            },
            createChartOptions("Discharge Over Time", "Discharge (cumecs)", true)
          );
          };
        
          // dam details from live API
          const updateDamList = () => {
          elements.damList.innerHTML = dams
            .map(
              (dam) => {
                const redLevel = parseFloat(dam.redLevel);
                const orangeLevel = parseFloat(dam.orangeLevel);
                const blueLevel= parseFloat(dam.blueLevel);
                const waterLevel = parseFloat(dam.data[0].waterLevel);
                console.log(waterLevel, redLevel, orangeLevel, blueLevel);
                let alert = ``;
        
                if (waterLevel >= redLevel) {
                  alert  = `<div class="red-badge">ALERT</div>`;
                } else if (waterLevel >= orangeLevel) {
                  alert  = `<div class="orange-badge">ALERT</div>`;
                } else if (waterLevel >= blueLevel) {
                  alert  = `<div class="blue-badge">ALERT</div>`;
        
                }
        
                return `
                  <div class="card dam-item" data-name="${dam.name}">
                      <div class="card-content">
                        <div class="flex items-center gap-3">
                          <h3>${dam.name}</h3>
                        </div>
                        <div class="relative">
                        ${alert}
                        <div class="power-output">${formatValue(getPropertyValue(dam, currentSortOption.key),currentSortOption.key)}</div>
                      </div>
                    </div>
                  </div>
                `;
              }
            ).join("");
        
          document.querySelectorAll(".dam-item").forEach((item) => {
            item.addEventListener("click", () => {
              const damName = item.dataset.name;
              const dam = dams.find((d) => d.name === damName);
              showDamDetails(dam);
            });
          });
        };
        
          const propertyGetters = {
            name: (dam) => dam.name,
            storagePercentage: (dam) => parseFloat(dam.data[0].storagePercentage),
            waterLevel: (dam) => parseFloat(dam.data[0].waterLevel),
            liveStorage: (dam) => parseFloat(dam.data[0].liveStorage),
            totalCapacity: (dam) => parseFloat(dam.liveStorageAtFRL),
            inflow: (dam) => parseFloat(dam.data[0].inflow),
            powerhouseDischarge: (dam) => parseFloat(dam.data[0].powerHouseDischarge),
            spillwayRelease: (dam) => parseFloat(dam.data[0].spillwayRelease),
            totalOutflow: (dam) => parseFloat(dam.data[0].totalOutflow),
            rainfall: (dam) => parseFloat(dam.data[0].rainfall),
          };
        
          const getPropertyValue = (dam, property) => {
            const getter = propertyGetters[property];
            return getter ? getter(dam) : 0;
          };
        
          // chart based on sort option
          const updateChart = () => {
            const ctx = document.getElementById("damChart").getContext("2d");
            if (chart) {
              chart.destroy();
            }
        
            let chartData, config;
        
            if (currentSortOption.key === "name") {
              const waterLevels = dams.map((dam) => parseFloat(dam.data[0].storagePercentage));
              const data = [0, 20, 40, 60, 80].map(
                (threshold, index, arr) =>
                  waterLevels.filter((l) => l > threshold && l <= (arr[index + 1] || 100)).length
              );
        
              chartData = {
                labels: ["0-20%", "21-40%", "41-60%", "61-80%", "81-100%"],
                datasets: [
                  {
                    label: "Number of Dams",
                    data: data,
                    backgroundColor: ["#90EE90", "#ADFF2F", "#FFFF00", "#FFA500", "#FF0000"],
                  },
                ],
              };
        
              config = {
                type: "bar",
                data: chartData,
                options: createChartOptions("Dam Water Level Distribution"),
              };
            } else {
              const top7Dams = dams.slice(0, 7);
              const labels = top7Dams.map((dam) => dam.name);
              const data = top7Dams.map((dam) => getPropertyValue(dam, currentSortOption.key));
        
              chartData = {
                labels: labels,
                datasets: [
                  {
                    label: currentSortOption.label,
                    data: data,
                    backgroundColor: getChartColors(data.length),
                    borderColor: getChartColors(data.length),
                    borderWidth: 1,
                  },
                ],
              };
        
              config = {
                type: currentSortOption.chartType,
                data: chartData,
                options: createChartOptions(currentSortOption.label),
              };
            }
        
            chart = new Chart(ctx, config);
          };
        
          const getChartColors = (count) => {
            const baseColors = ["#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0", "#9966FF", "#FF9F40", "#FF6B6B"];
            return baseColors.slice(0, count);
          };
        
          const addWaterLevelLegend = () => {
            const legend = L.control({ position: "topright" });
            legend.onAdd = () => {
              const div = L.DomUtil.create("div", "water-level-legend");
              div.innerHTML = `
                <h4>Water Level Scale</h4>
                ${[0, 20, 40, 60, 80]
                  .map(
                    (threshold, index) => `
                    <div class="water-level-item">
                      <span class="water-level-color" style="background-color: ${getWaterLevelColor(threshold + 1)};"></span>
                      ${threshold + 1}-${index === 4 ? 100 : threshold + 20}%
                    </div>
                  `
                  )
                  .join("")}
              `;
              return div;
            };
            legend.addTo(map);
          };
        
          elements.sortButton.addEventListener("click", () => {
            const currentIndex = sortOptions.indexOf(currentSortOption);
            currentSortOption = sortOptions[(currentIndex + 1) % sortOptions.length];
            elements.sortButton.textContent = `Sort by ${currentSortOption.label}`;
        
            dams.sort((a, b) =>
              currentSortOption.key === "name"
                ? a.name.localeCompare(b.name)
                : getPropertyValue(b, currentSortOption.key) - getPropertyValue(a, currentSortOption.key)
            );
            updateDamList();
            updateChart();
          });
        
          const fetchDamData = async () => {
            try {
              const response = await fetch(
                "https://raw.githubusercontent.com/amith-vp/Kerala-Dam-Water-Levels/main/live.json"
              );
              const data = await response.json();
              dams = data.dams;
              const lastUpdateText = `Last Updated: ${data.lastUpdate}`;
              elements.lastUpdate.textContent = lastUpdateText;
              elements.mobileLastUpdate.textContent = lastUpdateText;
              dams.sort(
                (a, b) =>
                  getPropertyValue(b, currentSortOption.key) - getPropertyValue(a, currentSortOption.key)
              );
              updateDamList();
              updateChart();
              updateMarkers();
            } catch (error) {
              console.error("Error fetching dam data:", error);
            }
          };
        
          elements.closeButton.addEventListener("click", () => {
            elements.damDetails.style.display = "none";
          });
        
          fetchDamData();
          addWaterLevelLegend();
        });
    </script>
</body>

</html>
